{
    admin off
    auto_https off
}

:{$PORT:80} {
    # Proxy API requests to Go backend (must come first)
    handle /api/* {
        reverse_proxy localhost:8080
    }

    # Serve static files for everything else
    handle {
        root * /srv

        # Cache static assets (images, fonts) — 1 year
        @static path *.jpg *.jpeg *.png *.gif *.webp *.webm *.mp4 *.svg *.ico *.woff *.woff2 *.ttf *.eot
        header @static Cache-Control "public, max-age=31536000, stale-while-revalidate=86400"

        # Cache CSS/JS — 1 week (Hugo fingerprints CSS but not all assets)
        @assets path *.css *.js
        header @assets Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

        try_files {path} {path}/ /index.html
        file_server
    }

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    encode gzip zstd

    log {
        output stdout
        format console
    }
}
